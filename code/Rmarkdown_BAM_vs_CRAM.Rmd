---
title: "Sarek Paper"
subtitle: "BAM vs CRAM"
author: "Friederike Hanssen"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true                               # table of contents
    toc_float: true                        # float the table of contents to the left of the main document content
    toc_depth: 3                            # header levels 1,2,3
    theme: default
    number_sections: true                   # add section numbering to headers
    df_print: paged                         # tables are printed as an html table with support for pagination over rows and columns
    css: ./qbic-style.css
    highlight: pygments
    pdf_document: true
---

<!-- QBiC Logo -->

<img src="./QBiCLogo.png" style="position:absolute;top:0px;right:0px;" height="120" width="120"/>

::: watermark
QBiC
:::

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Import all R libraries
library(dplyr)
library(patchwork)
library(forcats)
library(ggplot2)
library(cowplot)
library(knitr)
library(kableExtra)
library(ggpubr)
library(viridisLite)
library(tidyr)

theme_set(theme_gray())
results_folder <- "results/"
dir.create(results_folder)

source("./functions.R")
```

------------------------------------------------------------------------

# Introduction

These experiments investigate how BAM vs CRAM file formats compare with respect too cpu, memory, runtime, and storage usage.

### **Goal**

We switched from BAM to CRAM file format . While it has been shown that this reduces storage spaces, we should show that this is really the case and to which extent and addtionally how this impacts the other metrics for all relevant tools:

-   BQSR

<!-- -->

-   QC Tools

-   variant callers

Since there is limited space on the cluster, these experiments are subdivided.

#### Run commands

    nextflow run nf-core/sarek -r 3.0 -profile cfc --input --outdir -c trace.config -c custom.config

    custom.config

#### For each sample: preprocessing, default

This runs through mapping, duplicate marking, BQSR, and QC for BWA & non-spark GATK implementation.

|                |            |            | CRAM              | CRAM         | CRAM                                                                                   | CRAM    | BAM               | BAM          | BAM     | BAM     |
|----------------|------------|------------|-------------------|--------------|----------------------------------------------------------------------------------------|---------|-------------------|--------------|---------|---------|
| sample         | QBiC Code  | input size | work folder sizes | trace.config | towerID                                                                                | resumed | work folder sizes | trace.config | towerID | resumed |
| CHC982 normal  | QSARK011AX | 84G        | x                 | x            | <http://cfgateway1.zdv.uni-tuebingen.de/orgs/QBiC/workspaces/Dev/watch/5cXiGGJYsoGjh8> | yes     |                   |              |         |         |
| CHC982 tumor   | QSARK012A7 | 146G       | x                 | x            | <http://cfgateway1.zdv.uni-tuebingen.de/orgs/QBiC/workspaces/Dev/watch/5cXiGGJYsoGjh8> | yes     |                   |              |         |         |
| CHC912 normal  | QSARK013AF | 98G        |                   |              | <http://cfgateway1.zdv.uni-tuebingen.de/orgs/QBiC/workspaces/Dev/watch/2walbMPOXeFgjT> |         |                   |              |         |         |
| CHC912 tumor   | QSARK014AN | 166G       |                   |              | <http://cfgateway1.zdv.uni-tuebingen.de/orgs/QBiC/workspaces/Dev/watch/2walbMPOXeFgjT> |         |                   |              |         |         |
| CHC2111 normal |            |            |                   |              |                                                                                        |         |                   |              |         |         |
| CHC2111 tumor  |            |            |                   |              |                                                                                        |         |                   |              |         |         |
| CHC2113 normal |            |            |                   |              |                                                                                        |         |                   |              |         |         |
| CHC2113 tumor  |            |            |                   |              |                                                                                        |         |                   |              |         |         |
| CHC2115 normal |            |            |                   |              |                                                                                        |         |                   |              |         |         |
| CHC2115 tumor  |            |            |                   |              |                                                                                        |         |                   |              |         |         |

#### For each sample: preprocessing, spark

This runs through mapping with query-name sorting, duplicate marking, BQSR, and QC for BWA & spark GATK implementation.

|                |            |            | CRAM              | CRAM         | CRAM    | CRAM    | BAM               | BAM          | BAM     | BAM     |
|----------------|------------|------------|-------------------|--------------|---------|---------|-------------------|--------------|---------|---------|
| sample         | QBiC Code  | input size | work folder sizes | trace.config | towerID | resumed | work folder sizes | trace.config | towerID | resumed |
| CHC982 normal  | QSARK011AX | 84G        |                   |              |         |         |                   |              |         |         |
| CHC982 tumor   | QSARK012A7 | 146G       |                   |              |         |         |                   |              |         |         |
| CHC912 normal  | QSARK013AF | 98G        |                   |              |         |         |                   |              |         |         |
| CHC912 tumor   | QSARK014AN | 166G       |                   |              |         |         |                   |              |         |         |
| CHC2111 normal |            |            |                   |              |         |         |                   |              |         |         |
| CHC2111 tumor  |            |            |                   |              |         |         |                   |              |         |         |
| CHC2113 normal |            |            |                   |              |         |         |                   |              |         |         |
| CHC2113 tumor  |            |            |                   |              |         |         |                   |              |         |         |
| CHC2115 normal |            |            |                   |              |         |         |                   |              |         |         |
| CHC2115 tumor  |            |            |                   |              |         |         |                   |              |         |         |

#### For each samples: variantcalling, somatic and normal

    nextflow run nf-core/sarek -r 3.0 -profile cfc --input --outdir -c trace.config -c custom.config --step variantcalling --tools `all`

|                |            |            | CRAM              | CRAM         | CRAM    | CRAM    | BAM               | BAM          | BAM     | BAM     |
|----------------|------------|------------|-------------------|--------------|---------|---------|-------------------|--------------|---------|---------|
| sample         | QBiC Code  | input size | work folder sizes | trace.config | towerID | resumed | work folder sizes | trace.config | towerID | resumed |
| CHC982 normal  | QSARK011AX | 84G        |                   |              |         |         |                   |              |         |         |
| CHC982 tumor   | QSARK012A7 | 146G       |                   |              |         |         |                   |              |         |         |
| CHC912 normal  | QSARK013AF | 98G        |                   |              |         |         |                   |              |         |         |
| CHC912 tumor   | QSARK014AN | 166G       |                   |              |         |         |                   |              |         |         |
| CHC2111 normal |            |            |                   |              |         |         |                   |              |         |         |
| CHC2111 tumor  |            |            |                   |              |         |         |                   |              |         |         |
| CHC2113 normal |            |            |                   |              |         |         |                   |              |         |         |
| CHC2113 tumor  |            |            |                   |              |         |         |                   |              |         |         |
| CHC2115 normal |            |            |                   |              |         |         |                   |              |         |         |
| CHC2115 tumor  |            |            |                   |              |         |         |                   |              |         |         |

#### For each sample: variantcalling, tumor-only

| sample        | QBiC Code  | input size | work folder sizes | trace.config | towerID | resumed |
|---------------|------------|------------|-------------------|--------------|---------|---------|
| CHC982 tumor  | QSARK012A7 | 146G       |                   |              |         |         |
| CHC912 tumor  | QSARK014AN | 166G       |                   |              |         |         |
| CHC2111 tumor |            |            |                   |              |         |         |
| CHC2113 tumor |            |            |                   |              |         |         |
| CHC2115 tumor |            |            |                   |              |         |         |

To determine work folder size:

\`\`\`console`du -hb --all --max-depth=4 <absolute/path/to>/work/ > folder_sizes.tsv`\`\`\`

# Loading the dataset

Loading all the individual samples. Print sample summary if possible (e.g. metadata sheet).

```{r input, echo=FALSE}
# Load your own data (e.g. in data/)

# Load file and folder size info tables
storage_preprocessing_default_CHC982 <- read.csv(file = '/Users/monarchy/Projects/sarek_paper/bam_vs_cram/preprocessing_default/CRAM/pipeline_info_CHC982/folder_sizes.tsv', sep = "\t", stringsAsFactors = FALSE, header = FALSE)

# Load trace information
trace_preprocessing_default_CHC982 <- read.csv(file = '/Users/monarchy/Projects/sarek_paper/bam_vs_cram/preprocessing_default/CRAM/pipeline_info_CHC982/execution_trace_2022-08-12_09-00-45.txt', sep = "\t", stringsAsFactors = FALSE)
```

TODO: When more are available, will need to do some magic to join the data frames

### Clean data

```{r}

# Rename columns from storage files ( no headers by default)
names(storage_preprocessing_default_CHC982)[names(storage_preprocessing_default_CHC982) == "V2"] <- "workdir"
names(storage_preprocessing_default_CHC982)[names(storage_preprocessing_default_CHC982) == "V1"] <- "workdir_bytes"

```

```{r}
# Merge both tables on key workdir
merged_preprocessing_default_CHC982 <- merge(trace_preprocessing_default_CHC982, storage_preprocessing_default_CHC982, by = "workdir")
```

```{r}
merged_preprocessing_default_CHC982_formatted <- 
  merged_preprocessing_default_CHC982 %>% 
  # Convert vmem to megabytes and gigabytes
  mutate('vmem_MB' = bytesto(vmem, 'm')) %>%
  mutate('vmem_GB' = bytesto(vmem, 'g')) %>%
  # Convert peak_vmem to megabytes and gigabytes
  mutate('peak_vmem_MB' = bytesto(peak_vmem, 'm')) %>%
  mutate('peak_vmem_GB' = bytesto(peak_vmem, 'g')) %>%
  # Convert requested memory to megabytes and gigabytes
  mutate('memory_MB' = bytesto(memory, 'm')) %>%
  mutate('memory_GB' = bytesto(memory, 'g')) %>%
  # Get an actual CPU number by dividing the used cpu number by 100
  mutate('num_cpu' = X.cpu/100) %>%
  # Get last element (by :) from process name
  mutate('simple_name' = sub("^.*:", "", process)) %>%
  # Convert workdir storage to megabytes and gigabytes
  mutate('workdir_MB' = bytesto(workdir_bytes, 'm')) %>%
  mutate('workdir_GB' = bytesto(workdir_bytes, 'g')) %>%
  # Convert seconds to minutes
  mutate('realtime_min' = realtime/(60*1000)) %>%
  # Get tumor/normal
  mutate('status' = case_when(
    grepl("N", tag) ~ "normal", 
    grepl("T", tag) ~ "tumor",
    TRUE ~ "other"))

```

### CPU Usage

```{r}
ggplot(data=merged_preprocessing_default_CHC982_formatted, aes(x=simple_name, y=num_cpu)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=1, notch=FALSE) +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=status)) + 
  geom_point(aes(y=cpus), shape=8) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1))
```

### Memory Usage

```{r}
ggplot(data=merged_preprocessing_default_CHC982_formatted, aes(x=simple_name, y=vmem_MB)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2, notch=FALSE) +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=status)) + 
  geom_point(aes(y=memory_MB), shape=8) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) 
```

```{r}
ggplot(data=merged_preprocessing_default_CHC982_formatted, aes(x=simple_name, y=peak_vmem_MB)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2, notch=FALSE) +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=status)) +
  geom_point(aes(y=memory_MB), shape=8) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) 
```

### Storage usage

```{r}
ggplot(data=merged_preprocessing_default_CHC982_formatted, aes(x=simple_name, y=workdir_GB)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2, notch=FALSE) +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=status)) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) 
```

### Real time

```{r}
ggplot(data=merged_preprocessing_default_CHC982_formatted, aes(x=simple_name, y=realtime_min)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2, notch=FALSE) +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=status)) + 
  geom_point(aes(y=time/(60*1000)), shape=8) + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) 
```

### Combine plots

```{r}
merged_preprocessing_default_CHC982_long <- tidyr::gather(merged_preprocessing_default_CHC982_formatted, key="measure", value="value", c("num_cpu","workdir_GB","peak_vmem_GB"))

```

```{r}
variable_names <- list(
  "peak_vmem_GB" = "Peak Mem(GB)",
  "num_cpu" = "num CPU",
  "workdir_GB" = "work (GB)",
  "vmem_GB" = "Mem (GB)"
)

variable_labeller_y <- function(variable,value){
  return(variable_names[value])
}

ggplot(merged_preprocessing_default_CHC982_long, aes(x=simple_name, y=value))+
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2, notch=FALSE) +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=status)) + 
  facet_wrap(~measure, ncol=1, strip.position = "left", scales="free_y", labeller = variable_labeller_y) + 
  theme(axis.text.x = element_text(angle=35, hjust = 1), legend.position="none") 
```

# Methods

Package versions:

```{r, echo=F}
installed.packages()[names(sessionInfo()$otherPkgs), "Version"]
```
