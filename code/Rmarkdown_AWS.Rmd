---
title: "Sarek Paper"
subtitle: "AWS costs"
author: "Friederike Hanssen"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true                               # table of contents
    toc_float: true                        # float the table of contents to the left of the main document content
    toc_depth: 3                            # header levels 1,2,3
    theme: default
    number_sections: true                   # add section numbering to headers
    df_print: paged                         # tables are printed as an html table with support for pagination over rows and columns
    css: ./qbic-style.css
    highlight: pygments
    pdf_document: true
---

<!-- QBiC Logo -->

<img src="./QBiCLogo.png" style="position:absolute;top:0px;right:0px;" height="120" width="120"/>

::: watermark
QBiC
:::

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Import all R libraries
library(dplyr)
library(patchwork)
library(forcats)
library(ggplot2)
library(cowplot)
library(knitr)
library(kableExtra)
library(ggpubr)
library(viridisLite)

theme_set(theme_gray())
results_folder <- "results/"
dir.create(results_folder)

source("./functions.R")
```

------------------------------------------------------------------------

# Introduction

This script plots the costs when running sarek on AWS using Tower Forge. The following experiments are conducted:

+------------------------+---------------------------------------------------------------------------+-----------------------------------------------------------------+---------------------+-----------------+
| Name                   | Description                                                               | Tower ID                                                        | Parameters          | Resource config |
+========================+===========================================================================+=================================================================+=====================+=================+
| Germline Single sample | Sarek 3.0 run, with optimised resource requests for CHC982, germline only | <https://tower.nf/user/friederike-hanssen/watch/4GLbIcExOdptqD> | \--tools strelka    |                 |
|                        |                                                                           |                                                                 |                     |                 |
|                        |                                                                           |                                                                 | \--aligner bwa-mem2 |                 |
|                        |                                                                           |                                                                 |                     |                 |
|                        |                                                                           |                                                                 | \--input            |                 |
|                        |                                                                           |                                                                 |                     |                 |
|                        |                                                                           |                                                                 | \--outdir           |                 |
|                        |                                                                           |                                                                 |                     |                 |
|                        |                                                                           |                                                                 | \--igenomes_base    |                 |
|                        |                                                                           |                                                                 |                     |                 |
|                        |                                                                           |                                                                 | \--trace_dir        |                 |
+------------------------+---------------------------------------------------------------------------+-----------------------------------------------------------------+---------------------+-----------------+

# Loading the dataset

Costs are estimated with respect to different aspects: instance type, service, and usage type. The files are downloaded from the AWS cost explorer by only searching for the date in the file name + respective selector. The downloaded files unfortunately don't include a final empty line to indicate end-of-file. Therefore, all files need to be opened and an additional needs to be added manually. For the final plots only the usage type is needed. However, plotting the other two allows for quick sanity checks.

```{r input, echo=FALSE}
# Load your own data (e.g. in data/)

# Load cost tables
germline_singlesample_30_instance_raw <- read.csv(file = '/Users/monarchy/Projects/sarek_paper/aws_costs/towerid_4GLbIcExOdptqD_instancetype_aug13.csv', stringsAsFactors = FALSE)
germline_singlesample_30_service_raw <-  read.csv(file = '/Users/monarchy/Projects/sarek_paper/aws_costs/towerid_4GLbIcExOdptqD_service_aug13.csv', stringsAsFactors = FALSE)
germline_singlesample_30_usage_raw <-  read.csv(file = '/Users/monarchy/Projects/sarek_paper/aws_costs/towerid_4GLbIcExOdptqD_usagetype_aug13.csv', stringsAsFactors = FALSE)
```

```{r format, echo=FALSE}
# Format input table to have costs as columns and categories as rows.
germline_singlesample_30_instance <- format_aws_costs(germline_singlesample_30_instance_raw)
germline_singlesample_30_service <- format_aws_costs(germline_singlesample_30_service_raw)
germline_singlesample_30_usage <- format_aws_costs(germline_singlesample_30_usage_raw)
```

# Overview of costs per aggregation type

Costs by instance:

```{r instancecosts, echo=FALSE}
# plot costs per instance type
ggplot(data=germline_singlesample_30_instance, aes(x=type, y=costs)) + 
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) +
  geom_text(aes(label = sprintf("%0.3f", round(costs, digits = 3))), vjust = -0.3, size=3)
```

Costs by service:

```{r servicecosts, echo=FALSE}
# plot costs per instance type
ggplot(data=germline_singlesample_30_service, aes(x=type, y=costs)) + 
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle=45, hjust = 1)) +
  geom_text(aes(label = sprintf("%0.3f", round(costs, digits = 3))), vjust = -0.3, size=3)
```

Costs by usage:

```{r usagecosts, echo=FALSE}
# plot costs per instance type
ggplot(data=germline_singlesample_30_usage, aes(x=type, y=costs)) + 
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle=60, hjust = 1)) +
  geom_text(aes(label = sprintf("%0.3f", round(costs, digits = 3))), vjust = -0.3, size=3)
```

# Overall cost usage

Aggregate and group costs:

```{r group}

## Assign groups to each row type, default to "other"
germline_singlesample_30_usage <- germline_singlesample_30_usage %>%
    mutate(category = case_when(
    startsWith(type, "SpotUsage") ~ "EC2 Instances",
    startsWith(type, "BoxUsage") ~ "EC2 Instances",
    startsWith(type, "Total") ~ "Total",
    startsWith(type, "Timed") ~ "S3",
    startsWith(type, "Requests") ~ "S3",
    TRUE ~ "EC2 Other"
    ))
```

```{r sum}
germline_singlesample_30_usage_aggr <- germline_singlesample_30_usage %>%
  # To calculate total costs per category, groupby it, then sum over it
  group_by(category) %>% 
  summarise(costs = sum(costs)) %>% 
  # add everything after original dataset (rows)
  bind_rows(germline_singlesample_30_usage, .) %>%  
  # The new rows don't have a type, copy values from category column to type
  mutate(type = coalesce(type,category)) %>%
  # Change the category of the new values to "total"
  mutate(category = replace(category, type == "EC2 Instances","Total")) %>%
  mutate(category = replace(category, type == "EC2 Other","Total")) %>%
  mutate(category = replace(category, type == "S3","Total")) %>%
  mutate(category = replace(category, type == "EC2 Other","Total")) %>%
  # Remove the now duplicated total cost row (keep all where type != Total)
  filter(type!='Total')

```

```{r color}
germline_singlesample_30_usage_aggr <- germline_singlesample_30_usage_aggr %>%
    mutate(color = case_when(
    startsWith(category, "EC2 Instances") ~ "EC2 Instances",
    startsWith(category, "EC2 Other") ~ "EC2 Other",
    startsWith(category, "S3") ~ "S3",
    startsWith(type, "EC2 Instances") ~ "EC2 Instances",
    startsWith(type, "EC2 Other") ~ "EC2 Other",
    startsWith(type, "S3") ~ "S3",
    startsWith(type, "Total") ~ "Total",
    ))
```

```{r plot_aggregate, width = 30 , units ="cm"}

ggplot(data=germline_singlesample_30_usage_aggr, aes(x=type, y=costs,fill=color)) + 
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle=90, hjust = 1)) +
  theme(legend.position="none") + 
  geom_text(aes(label = sprintf("%0.3f", round(costs, digits = 3))), vjust = -0.3, size=2.5) +
  facet_grid(~category, scales="free", space="free_x")
```

Todo:

1.  How should we handle maintenance costs? subtract?
2.  Naming a bit ugly....

# Methods

Package versions:

```{r, echo=F}
installed.packages()[names(sessionInfo()$otherPkgs), "Version"]
```
